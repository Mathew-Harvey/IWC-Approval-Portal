<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IWC Notification Package Generator | Franmarine</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header no-print">
            <div class="logo">
                <h1>IWC Notification Package Generator</h1>
                <span class="subtitle">Franmarine Underwater Services</span>
            </div>
            <div class="header-actions" id="authContainer">
                <button id="btnNewJob" class="btn btn-secondary">New Job</button>
                <button id="btnLoadJob" class="btn btn-secondary">Load Saved</button>
                <button id="btnSettings" class="btn btn-icon" title="Settings">‚öôÔ∏è</button>
                
                <!-- User Menu (shown when logged in) -->
                <div class="user-menu" id="userMenu">
                    <button class="user-menu-trigger" id="userMenuTrigger">
                        <img id="userAvatar" src="/img/default-avatar.png" alt="User" class="user-avatar">
                        <span id="userName">User</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <div class="user-menu-header">
                            <img id="userAvatarLarge" src="/img/default-avatar.png" alt="User" class="user-avatar-large">
                            <div class="user-info">
                                <strong id="userNameFull">User Name</strong>
                                <span id="userEmail">user@example.com</span>
                            </div>
                        </div>
                        <div class="user-menu-items">
                            <a href="#" id="btnDashboard" class="user-menu-item">üìä Dashboard</a>
                            <a href="#" id="btnMyJobs" class="user-menu-item">üìã My Jobs</a>
                            <a href="#" id="btnUserSettings" class="user-menu-item">‚öôÔ∏è Settings</a>
                            <div class="user-menu-divider"></div>
                            <a href="#" id="logoutBtn" class="user-menu-item text-danger">üö™ Sign Out</a>
                        </div>
                    </div>
                </div>
                
                <!-- Login Button (shown when logged out) -->
                <button id="loginBtn" class="btn btn-primary">
                    Sign In
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Form Panel -->
            <section class="form-panel no-print" id="formPanel">
                <form id="jobForm">
                    <!-- Jurisdiction Selector -->
                    <fieldset class="form-section jurisdiction-section">
                        <legend>üåç Operating Jurisdiction</legend>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="jurisdictionSelect">Select the jurisdiction where this work will be performed</label>
                                <select id="jurisdictionSelect" class="jurisdiction-select">
                                    <!-- Populated dynamically by jurisdiction system -->
                                </select>
                                <div class="jurisdiction-help-row">
                                    <small class="help-text" id="jurisdictionHelpText">
                                        This determines applicable regulations, approval processes, and emergency contacts.
                                    </small>
                                    <button type="button" id="btnApprovalProcess" class="link-button">
                                        <span class="link-icon">üìã</span> View approval process
                                    </button>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Job Details -->
                    <fieldset class="form-section">
                        <legend>Job Details</legend>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="jobNumber">Job Number</label>
                                <input type="text" id="jobNumber">
                            </div>
                            <div class="form-group">
                                <label for="clientName">Client Name</label>
                                <input type="text" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label for="proposedStartDate">Proposed Start Date</label>
                                <input type="date" id="proposedStartDate" required>
                            </div>
                            <div class="form-group">
                                <label for="estimatedDuration">Estimated Duration (days)</label>
                                <input type="number" id="estimatedDuration" min="1" value="1">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Vessel Details -->
                    <fieldset class="form-section">
                        <legend>Vessel Details</legend>
                        <div class="vessel-lookup">
                            <div class="form-group">
                                <label for="vesselSearch">Search by MMSI, IMO, or Name</label>
                                <div class="search-input">
                                    <input type="text" id="vesselSearch" placeholder="Enter MMSI (9 digits), IMO (7 digits), or vessel name">
                                    <button type="button" id="btnSearchVessel" class="btn btn-primary">Search</button>
                                </div>
                                <small class="help-text">Powered by Marinesia API</small>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="vesselName">Vessel Name</label>
                                <input type="text" id="vesselName" required>
                            </div>
                            <div class="form-group">
                                <label for="imoNumber">IMO Number</label>
                                <input type="text" id="imoNumber" placeholder="7 digits">
                            </div>
                            <div class="form-group">
                                <label for="mmsiNumber">MMSI</label>
                                <input type="text" id="mmsiNumber" placeholder="9 digits">
                            </div>
                            <div class="form-group">
                                <label for="vesselType">Vessel Type</label>
                                <input type="text" id="vesselType">
                            </div>
                            <div class="form-group">
                                <label for="vesselLOA">LOA (m)</label>
                                <input type="number" id="vesselLOA" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="vesselBeam">Beam (m)</label>
                                <input type="number" id="vesselBeam" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="vesselFlag">Flag</label>
                                <input type="text" id="vesselFlag">
                            </div>
                            <div class="form-group">
                                <label for="grossTonnage">Gross Tonnage</label>
                                <input type="number" id="grossTonnage">
                            </div>
                        </div>
                    </fieldset>

                    <!-- AFC Details -->
                    <fieldset class="form-section">
                        <legend>Anti-Fouling Coating (AFC)</legend>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="afcType">AFC Type</label>
                                <select id="afcType" required>
                                    <option value="">Select AFC Type</option>
                                    <option value="biocidal">Biocidal (copper-based, etc.)</option>
                                    <option value="non-biocidal">Non-biocidal (fouling release, silicone, etc.)</option>
                                    <option value="unknown">Unknown / Not documented</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="afcProductName">Product Name</label>
                                <input type="text" id="afcProductName" placeholder="e.g., ECOFLEX SPEC 600 HYB">
                            </div>
                            <div class="form-group">
                                <label for="afcApplicationDate">Application Date</label>
                                <input type="date" id="afcApplicationDate">
                            </div>
                            <div class="form-group">
                                <label for="afcServiceLife">Service Life (months)</label>
                                <input type="number" id="afcServiceLife" min="1" value="60">
                            </div>
                            <div class="form-group full-width">
                                <label>Prohibited Biocides Check</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="noProhibitedBiocides" checked>
                                        AFC does not contain diuron, cybutryne, ziram, tributyltin or chlorathonil
                                    </label>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label>AFC Condition</label>
                                <select id="afcCondition" required>
                                    <option value="sound">Sound condition - within service life</option>
                                    <option value="worn">Worn but functional</option>
                                    <option value="damaged">Damaged / compromised</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Vessel History -->
                    <fieldset class="form-section">
                        <legend>Vessel History & Operating Profile</legend>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="recentPortCalls">Recent Port Calls</label>
                                <textarea id="recentPortCalls" rows="3" placeholder="List recent ports visited..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="stationaryPeriods">Stationary Periods</label>
                                <textarea id="stationaryPeriods" rows="2" placeholder="Note any extended stationary periods..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="operatingProfile">Operating Profile Summary</label>
                                <textarea id="operatingProfile" rows="3" placeholder="e.g., Vessel primarily operating in the North West Shelf oil fields with visits to Victoria and Northern Territory..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="imsTrackingDoc">IMS Compliance Tracking Document</label>
                                <input type="text" id="imsTrackingDoc" placeholder="Document reference...">
                            </div>
                            <div class="form-group">
                                <label>Biofouling Origin</label>
                                <select id="biofoulingOrigin" required>
                                    <option value="regional">Regional (WA waters only)</option>
                                    <option value="domestic">Domestic (Australian waters)</option>
                                    <option value="international">International</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Scope of Work -->
                    <fieldset class="form-section">
                        <legend>Scope of Work</legend>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Areas to be Cleaned</label>
                                <div class="checkbox-group horizontal">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="scopeHull" checked>
                                        Hull
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="scopeNicheAreas">
                                        Niche Areas
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="scopePropeller">
                                        Propeller
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="cleaningLocation">Cleaning Location</label>
                                <select id="cleaningLocation" required>
                                    <option value="">Select Location</option>
                                    <!-- Populated dynamically based on jurisdiction -->
                                    <option value="other">Other (specify)</option>
                                </select>
                            </div>
                            <div class="form-group" id="otherLocationGroup" style="display:none;">
                                <label for="otherLocation">Specify Location</label>
                                <input type="text" id="otherLocation">
                            </div>
                            <div class="form-group full-width">
                                <label for="customScopeOfWork">Custom Scope of Work</label>
                                <textarea id="customScopeOfWork" rows="4" placeholder="If the standard scope doesn't apply, describe the custom scope here. This will override the default scope description in all generated documents."></textarea>
                                <small class="help-text">Leave blank to use the default scope based on selected areas above.</small>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Personnel & Dive Team -->
                    <fieldset class="form-section">
                        <legend>üë• Dive Team & Personnel</legend>
                        <div class="info-box">
                            <p>Enter the dive team members for this job. Personnel details will appear on the SWMS.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="diveSupervisor">Dive Supervisor *</label>
                                <input type="text" id="diveSupervisor" placeholder="Name" required>
                            </div>
                            <div class="form-group">
                                <label for="diveSupervisorADAS">ADAS Cert #</label>
                                <input type="text" id="diveSupervisorADAS" placeholder="e.g., 12345">
                            </div>
                            <div class="form-group">
                                <label for="diver1">Diver 1</label>
                                <input type="text" id="diver1" placeholder="Name">
                            </div>
                            <div class="form-group">
                                <label for="diver1ADAS">ADAS Cert #</label>
                                <input type="text" id="diver1ADAS" placeholder="e.g., 12345">
                            </div>
                            <div class="form-group">
                                <label for="diver2">Diver 2</label>
                                <input type="text" id="diver2" placeholder="Name">
                            </div>
                            <div class="form-group">
                                <label for="diver2ADAS">ADAS Cert #</label>
                                <input type="text" id="diver2ADAS" placeholder="e.g., 12345">
                            </div>
                            <div class="form-group">
                                <label for="diveTender">Dive Tender</label>
                                <input type="text" id="diveTender" placeholder="Name">
                            </div>
                            <div class="form-group">
                                <label for="diveTenderADAS">ADAS Cert #</label>
                                <input type="text" id="diveTenderADAS" placeholder="e.g., 12345">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Dive Parameters -->
                    <fieldset class="form-section">
                        <legend>ü§ø Dive Parameters</legend>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="maxDepth">Expected Max Depth (m)</label>
                                <input type="number" id="maxDepth" min="1" max="50" value="12" step="1">
                            </div>
                            <div class="form-group">
                                <label for="bottomTime">Expected Bottom Time (min)</label>
                                <select id="bottomTime">
                                    <option value="Unlimited" selected>Unlimited (No Deco)</option>
                                    <option value="60">60 minutes</option>
                                    <option value="90">90 minutes</option>
                                    <option value="120">120 minutes</option>
                                    <option value="Custom">Custom (specify in notes)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="decoProfile">Decompression Profile</label>
                                <select id="decoProfile">
                                    <option value="No Deco" selected>No Decompression Required</option>
                                    <option value="In-Water Stops">In-Water Stops</option>
                                    <option value="Surface Deco">Surface Decompression</option>
                                    <option value="DCIEM Tables">DCIEM Tables</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gasType">Breathing Gas</label>
                                <select id="gasType">
                                    <option value="Air" selected>Compressed Air</option>
                                    <option value="Nitrox">Nitrox (EAN)</option>
                                    <option value="Mixed Gas">Mixed Gas</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Equipment Selection -->
                    <fieldset class="form-section">
                        <legend>üîß Equipment Selection</legend>
                        <div class="info-box">
                            <p>Select all equipment that will be used on this job. This populates the SWMS equipment checklist.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Dive Equipment</label>
                                <div class="checkbox-group horizontal">
                                    <label class="checkbox-label"><input type="checkbox" id="equipDivePanel" checked> Dive Panel</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipUmbilicals" checked> Umbilicals</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipDiveHats" checked> Dive Hats/Masks</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipComms" checked> Comms System</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipBailout" checked> Bailout Cylinders</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipRecovery" checked> Recovery System</label>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label>Support Equipment</label>
                                <div class="checkbox-group horizontal">
                                    <label class="checkbox-label"><input type="checkbox" id="equipCompressor" checked> LP Compressor</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipFirstAid" checked> First Aid Kit</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipOxyviva" checked> Oxy-Viva</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipStretcher" checked> Stretcher</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipDiveFlag" checked> Dive Flag</label>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label>Cleaning Equipment</label>
                                <div class="checkbox-group horizontal">
                                    <label class="checkbox-label"><input type="checkbox" id="equipHPWasher"> HP Washer</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipBigBoy"> Big Boy System</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipROV"> ROV System</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipBrushCart"> Brush Cart</label>
                                    <label class="checkbox-label"><input type="checkbox" id="equipFilterUnit"> Filter Unit</label>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="otherEquipment">Other Equipment</label>
                                <input type="text" id="otherEquipment" placeholder="Specify any additional equipment...">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Client & Site Contacts -->
                    <fieldset class="form-section">
                        <legend>üìû Client & Site Contacts</legend>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="clientContact">Client Contact Name</label>
                                <input type="text" id="clientContact" placeholder="Site representative name">
                            </div>
                            <div class="form-group">
                                <label for="clientPhone">Client Phone</label>
                                <input type="tel" id="clientPhone" placeholder="e.g., 0412 345 678">
                            </div>
                            <div class="form-group">
                                <label for="simopsContact">SimOps Contact Name</label>
                                <input type="text" id="simopsContact" placeholder="If applicable">
                            </div>
                            <div class="form-group">
                                <label for="simopsPhone">SimOps Phone</label>
                                <input type="tel" id="simopsPhone" placeholder="e.g., 0412 345 678">
                            </div>
                            <div class="form-group">
                                <label for="emergencyAssembly">Emergency Assembly Point</label>
                                <input type="text" id="emergencyAssembly" placeholder="Muster location on site">
                            </div>
                            <div class="form-group">
                                <label for="onSiteMedic">On-Site Dive Medic?</label>
                                <select id="onSiteMedic">
                                    <option value="no" selected>No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Site-Specific Selection -->
                    <fieldset class="form-section">
                        <legend>üè≠ Site-Specific Requirements</legend>
                        <div class="info-box">
                            <p>Select if working at a specific client site. This will include relevant site-specific hazards in the SWMS.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="siteType">Site Type</label>
                                <select id="siteType">
                                    <option value="standard" selected>Standard Commercial Port</option>
                                    <option value="defence">Defence / Babcock (FBW/FBE/AMC)</option>
                                    <option value="anzac">ANZAC Class Frigates - Propeller Operations</option>
                                    <option value="fpa">Fremantle Ports Authority</option>
                                    <option value="dpworld">DP World / Svitzer Operations</option>
                                    <option value="navy">Other Navy Primes</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <div class="checkbox-group vertical">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="requiresPTW" checked>
                                        Permit to Work (PTW) Required
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="requiresIsolation" checked>
                                        Isolation/LOTO Required
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="requiresSiteInduction">
                                        Site-Specific Induction Required
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="requiresSecurityClearance">
                                        Security Clearance Required
                                    </label>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Additional Activities -->
                    <fieldset class="form-section">
                        <legend>‚ö†Ô∏è Additional Activities & Hazards</legend>
                        <div class="info-box">
                            <p>Select any additional activities that apply. These will add relevant hazards to the SWMS and considerations to other safety documents.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <div class="checkbox-group vertical">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="activityConfinedSpace">
                                        Confined Space Entry (tanks, cofferdams, chain lockers)
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="activityHotWork">
                                        Hot Work (welding, cutting, grinding)
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="activityWorkingAtHeights">
                                        Working at Heights (>2m above water/deck)
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="activityCraneOps">
                                        Crane/Lifting Operations
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="activityHazmat">
                                        Hazardous Materials Handling
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="activityNightWork">
                                        Night Work Operations
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="activityUnderwaterInspection">
                                        Underwater Inspection/Survey (beyond cleaning)
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="activityPropPolishing">
                                        Propeller Polishing (powered tools)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Biofouling Assessment -->
                    <fieldset class="form-section">
                        <legend>Preliminary Biofouling Assessment</legend>
                        <div class="info-box">
                            <p id="biofoulingInfoText">This is the preliminary assessment. Formal pre-clean inspection follows per regulatory requirements.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="foulingRating">Fouling Rating (FR)</label>
                                <select id="foulingRating" required>
                                    <option value="">Select FR</option>
                                    <option value="0">FR 0 - No microfouling (clean)</option>
                                    <option value="10">FR 10 - Light microfouling</option>
                                    <option value="20">FR 20 - Full microfouling (slime)</option>
                                    <option value="30">FR 30 - Moderate soft macrofouling</option>
                                    <option value="40">FR 40 - Moderate hard macrofouling (light)</option>
                                    <option value="50">FR 50 - Moderate hard macrofouling</option>
                                    <option value="60">FR 60 - Moderate hard macrofouling (tubeworms + barnacles)</option>
                                    <option value="70">FR 70 - Moderate hard macrofouling (>6.4mm)</option>
                                    <option value="80">FR 80 - Heavy hard macrofouling</option>
                                    <option value="90">FR 90 - Heavy hard macrofouling (dense)</option>
                                    <option value="100">FR 100 - Composite fouling (all forms)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="foulingCover">Fouling Cover (%)</label>
                                <select id="foulingCover" required>
                                    <option value="">Select Cover</option>
                                    <option value="0">0% - Absent</option>
                                    <option value="1-5">1-5% - Light</option>
                                    <option value="6-15">6-15% - Considerable</option>
                                    <option value="16-40">16-40% - Extensive</option>
                                    <option value="41-100">41-100% - Very heavy</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="foulingDescription">Fouling Description</label>
                                <textarea id="foulingDescription" rows="3" placeholder="Describe observed biofouling..."></textarea>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Auto-calculated Section -->
                    <fieldset class="form-section calculated-section">
                        <legend>Determined Requirements (Auto-calculated)</legend>
                        <div class="requirement-cards">
                            <div class="requirement-card" id="scenarioCard">
                                <h4>Cleaning Scenario</h4>
                                <p id="scenarioText">-</p>
                            </div>
                            <div class="requirement-card" id="captureCard">
                                <h4>Capture Required</h4>
                                <p id="captureText">-</p>
                            </div>
                            <div class="requirement-card" id="sapCard">
                                <h4>SAP Required</h4>
                                <p id="sapText">-</p>
                            </div>
                            <div class="requirement-card" id="riskCard">
                                <h4>Risk Level</h4>
                                <p id="riskText">-</p>
                            </div>
                        </div>
                        <div id="warningMessages" class="warning-messages"></div>
                    </fieldset>

                    <!-- Images -->
                    <fieldset class="form-section">
                        <legend>Images</legend>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="companyLogo">Company Logo (for document header)</label>
                                <div class="image-upload-container">
                                    <input type="file" id="companyLogo" accept="image/*" class="image-upload-input">
                                    <div class="image-preview" id="companyLogoPreview">
                                        <span class="placeholder-text">üì∑ Click or drag to upload logo</span>
                                    </div>
                                    <button type="button" class="btn btn-small btn-secondary" id="btnClearCompanyLogo" style="display:none;">Clear</button>
                                </div>
                                <small class="help-text">Recommended: PNG or SVG, 200x80px</small>
                            </div>
                            <div class="form-group">
                                <label for="vesselImage">Vessel Photo</label>
                                <div class="image-upload-container">
                                    <input type="file" id="vesselImage" accept="image/*" class="image-upload-input">
                                    <div class="image-preview vessel-preview" id="vesselImagePreview">
                                        <span class="placeholder-text">üì∑ Click or drag to upload vessel photo</span>
                                    </div>
                                    <button type="button" class="btn btn-small btn-secondary" id="btnClearVesselImage" style="display:none;">Clear</button>
                                </div>
                                <small class="help-text">Vessel photo for report covers</small>
                            </div>
                            <div class="form-group">
                                <label for="generalArrangement">General Arrangement</label>
                                <div class="image-upload-container">
                                    <input type="file" id="generalArrangement" accept="image/*" class="image-upload-input">
                                    <div class="image-preview ga-preview" id="generalArrangementPreview">
                                        <span class="placeholder-text">üìê Click or drag to upload GA drawing</span>
                                    </div>
                                    <button type="button" class="btn btn-small btn-secondary" id="btnClearGeneralArrangement" style="display:none;">Clear</button>
                                </div>
                                <small class="help-text">GA drawing for Work Method Statement</small>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Document Author -->
                    <fieldset class="form-section">
                        <legend>Document Author</legend>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="authorName">Prepared By</label>
                                <input type="text" id="authorName" value="Sam Diamond">
                            </div>
                            <div class="form-group">
                                <label for="revisionDate">Revision Date</label>
                                <input type="date" id="revisionDate">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Actions -->
                    <div class="form-actions">
                        <button type="button" id="btnSaveJob" class="btn btn-secondary">Save Draft</button>
                        <button type="button" id="btnGenerateEmail" class="btn btn-secondary">Generate Email</button>
                        <button type="button" id="btnGenerateWMS" class="btn btn-primary">Generate WMS</button>
                    </div>
                </form>
            </section>

            <!-- Output Panel -->
            <section class="output-panel" id="outputPanel">
                <div class="output-tabs no-print">
                    <button class="tab-btn active" data-tab="wms">WMS</button>
                    <button class="tab-btn" data-tab="erp">ERP</button>
                    <button class="tab-btn" data-tab="whsmp">WHSMP</button>
                    <button class="tab-btn" data-tab="swms">SWMS</button>
                    <button class="tab-btn" data-tab="email">Email</button>
                </div>
                <div class="output-actions no-print">
                    <button id="btnPrint" class="btn btn-secondary">Print / Save PDF</button>
                    <button id="btnCopyEmail" class="btn btn-secondary" style="display:none;">Copy to Clipboard</button>
                    <button id="btnGenerateAll" class="btn btn-primary">Generate All Docs</button>
                </div>
                <div class="output-content" id="outputContent">
                    <div class="placeholder-message">
                        <p>Complete the form and click "Generate WMS" to preview the document.</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Email Modal -->
        <div class="modal" id="emailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Notification Email</h2>
                    <button class="modal-close" id="closeEmailModal">&times;</button>
                </div>
                <div class="modal-body" id="emailContent">
                </div>
                <div class="modal-footer">
                    <button id="btnCopyEmailModal" class="btn btn-primary">Copy to Clipboard</button>
                    <button id="btnCloseEmailModal" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- Saved Jobs Modal -->
        <div class="modal" id="savedJobsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Saved Jobs</h2>
                    <button class="modal-close" id="closeSavedJobsModal">&times;</button>
                </div>
                <div class="modal-body" id="savedJobsList">
                </div>
            </div>
        </div>
    </div>


    <!-- Templates are now in external files: /templates/*.hbs -->
    <!-- Edit templates in the /templates folder -->

    <!-- Vessel Search Modal -->
    <div id="vesselSearchModal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content vessel-search-modal">
            <div class="modal-header">
                <h2>üö¢ Vessel Search Results</h2>
                <button class="modal-close" id="closeVesselModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="vesselSearchStatus" class="search-status">
                    <div class="search-spinner"></div>
                    <span>Searching...</span>
                </div>
                <div id="vesselSearchResults" class="vessel-results-grid">
                    <!-- Results will be populated here -->
                </div>
                <div id="noVesselResults" class="no-results" style="display: none;">
                    <p>üîç No vessels found matching your search.</p>
                    <p>You can enter the vessel details manually below.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnEnterManually">
                    ‚úèÔ∏è Enter Details Manually
                </button>
                <button type="button" class="btn btn-secondary" id="btnCancelSearch">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="settingsModalOverlay"></div>
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è API Settings</h2>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-info">
                    <p>Configure your API keys to enable vessel search. Keys are stored locally in your browser and never sent to our servers.</p>
                </div>
                
                <div class="settings-section">
                    <h3>üåê Marinesia API</h3>
                    <p class="settings-description">Primary vessel database for detailed vessel profiles.</p>
                    <div class="form-group">
                        <label for="marinesiaApiKey">API Key</label>
                        <div class="api-key-input">
                            <input type="password" id="marinesiaApiKey" placeholder="Enter your Marinesia API key">
                            <button type="button" class="btn btn-icon toggle-visibility" data-target="marinesiaApiKey">üëÅÔ∏è</button>
                        </div>
                        <small class="help-text">
                            <a href="https://marinesia.com" target="_blank" rel="noopener">Get a free API key ‚Üí</a>
                        </small>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üì° AISStream API</h3>
                    <p class="settings-description">Real-time AIS data for vessels worldwide. <strong>Note:</strong> Requires a backend server due to WebSocket restrictions.</p>
                    <div class="form-group">
                        <label for="aisstreamApiKey">API Key</label>
                        <div class="api-key-input">
                            <input type="password" id="aisstreamApiKey" placeholder="Enter your AISStream API key">
                            <button type="button" class="btn btn-icon toggle-visibility" data-target="aisstreamApiKey">üëÅÔ∏è</button>
                        </div>
                        <small class="help-text">
                            <a href="https://aisstream.io" target="_blank" rel="noopener">Get a free API key ‚Üí</a>
                        </small>
                    </div>
                    <div class="settings-note">
                        <span class="note-icon">‚ÑπÔ∏è</span>
                        <span>AISStream only works when running with the proxy server (<code>npm start</code>). On GitHub Pages, only Marinesia and demo data are available.</span>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üîó Deployment Mode</h3>
                    <div class="deployment-status" id="deploymentStatus">
                        <div class="status-item">
                            <span class="status-label">Mode:</span>
                            <span class="status-value" id="deploymentMode">Checking...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Marinesia:</span>
                            <span class="status-value" id="marinesiaStatus">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">AISStream:</span>
                            <span class="status-value" id="aisstreamStatus">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnTestConnection">Test Connection</button>
                <button type="button" class="btn btn-primary" id="btnSaveSettings">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Approval Process Modal -->
    <div id="approvalProcessModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="approvalProcessModalOverlay"></div>
        <div class="modal-content approval-process-modal">
            <div class="modal-header">
                <h2 id="approvalProcessTitle">üìã Approval Process</h2>
                <button class="modal-close" id="closeApprovalProcessModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="approvalProcessContent" class="approval-process-content">
                    <!-- Dynamically populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnCloseApprovalProcess">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- API & Auth Services (must load first) -->
    <script src="js/services/api.js"></script>
    <script src="js/services/authState.js"></script>
    
    <!-- Core Services -->
    <script src="js/utils/scenarioLogic.js"></script>
    <script src="js/services/storage.js"></script>
    <script src="js/services/jobNumber.js"></script>
    <script src="js/services/vesselApi.js"></script>
    <script src="js/templateLoader.js"></script>
    
    <!-- Jurisdiction Configuration -->
    <script src="js/jurisdictions/config.js"></script>
    <script src="js/jurisdictions/au-wa.js"></script>
    <script src="js/jurisdictions/nz.js"></script>
    <script src="js/jurisdictions/sg.js"></script>
    <script src="js/jurisdictions/us-ca.js"></script>
    <script src="js/jurisdictions/jp.js"></script>
    <script src="js/jurisdictions/index.js"></script>
    
    <!-- Form Enhancement Utilities -->
    <script src="js/utils/formEnhancements.js"></script>
    <script src="js/utils/foulingSlider.js"></script>
    <script src="js/utils/printPreview.js"></script>
    <script src="js/utils/userMenu.js"></script>
    
    <script src="js/app.js"></script>
    
    <!-- Clerk Authentication -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_b2JsaWdpbmctbWFsbGFyZC0yLmNsZXJrLmFjY291bnRzLmRldiQ"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        type="text/javascript"
        id="clerk-script"
    ></script>
    
    <!-- Initialize Auth with Clerk -->
    <script>
        // Wait for DOM and Clerk to load
        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch Clerk publishable key from server config
            let clerkKey = document.getElementById('clerk-script')?.dataset?.clerkPublishableKey;
            
            if (!clerkKey) {
                try {
                    const response = await fetch('/api/config');
                    const config = await response.json();
                    clerkKey = config.clerkPublishableKey;
                    
                    if (clerkKey) {
                        const clerkScript = document.getElementById('clerk-script');
                        if (clerkScript) {
                            clerkScript.dataset.clerkPublishableKey = clerkKey;
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch Clerk config:', e);
                }
            }
            
            // Wait for Clerk to be available (longer timeout for slow free servers)
            const waitForClerk = () => new Promise((resolve) => {
                if (typeof Clerk !== 'undefined') {
                    resolve();
                    return;
                }
                
                const startTime = Date.now();
                const timeout = 15000; // 15 seconds for slow servers
                
                const check = setInterval(() => {
                    if (typeof Clerk !== 'undefined') {
                        clearInterval(check);
                        console.log('‚úÖ Clerk SDK loaded');
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        clearInterval(check);
                        console.warn('‚ö†Ô∏è Clerk SDK not loaded after timeout - continuing without auth');
                        resolve();
                    }
                }, 100);
            });
            
            await waitForClerk();
            
            // Initialize auth state
            await AuthState.init();
            
            // Initialize User Menu (Dashboard, My Jobs)
            if (typeof UserMenu !== 'undefined') {
                UserMenu.init();
            }
            
            // Bind auth events after init
            document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                AuthState.signOut();
            });
            
            // User profile button
            document.getElementById('btnUserSettings')?.addEventListener('click', (e) => {
                e.preventDefault();
                AuthState.openUserProfile();
            });
            
            // User menu toggle
            document.getElementById('userMenuTrigger')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('userMenuDropdown')?.classList.toggle('active');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', () => {
                document.getElementById('userMenuDropdown')?.classList.remove('active');
            });
        });
        
    </script>
    
    <!-- Login button handler - separate to ensure it works immediately -->
    <script>
        // Bind login button as soon as DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const loginBtn = document.getElementById('loginBtn');
            let isLoading = false;
            
            if (loginBtn) {
                loginBtn.addEventListener('click', async function(event) {
                    // CRITICAL: Prevent any default behavior and bubbling
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Prevent double-clicks while loading
                    if (isLoading) {
                        console.log('Already loading, please wait...');
                        return;
                    }
                    
                    console.log('Sign In button clicked');
                    
                    // Show loading state (for slow servers)
                    const originalText = loginBtn.textContent;
                    loginBtn.textContent = 'Loading...';
                    loginBtn.disabled = true;
                    isLoading = true;
                    
                    try {
                        // Check if Clerk is available
                        if (typeof Clerk !== 'undefined') {
                            // Make sure Clerk is loaded first
                            if (!Clerk.loaded) {
                                console.log('Loading Clerk SDK...');
                                await Clerk.load();
                                console.log('Clerk SDK loaded successfully');
                            }
                            
                            // CHECK IF USER IS ALREADY SIGNED IN
                            if (Clerk.user) {
                                console.log('User already signed in:', Clerk.user.emailAddresses?.[0]?.emailAddress);
                                // Update UI to show user is logged in
                                if (typeof AuthState !== 'undefined') {
                                    AuthState.clerkUser = Clerk.user;
                                    AuthState.setUser({
                                        email: Clerk.user.emailAddresses?.[0]?.emailAddress,
                                        name: Clerk.user.fullName || Clerk.user.firstName,
                                        picture: Clerk.user.imageUrl
                                    });
                                }
                                // Hide login button, show user menu
                                loginBtn.style.display = 'none';
                                const userMenu = document.getElementById('userMenu');
                                if (userMenu) userMenu.style.display = 'flex';
                                return;
                            }
                            
                            console.log('Opening Clerk sign in modal...');
                            
                            // Open sign in modal
                            Clerk.openSignIn({
                                redirectUrl: window.location.href
                            });
                            
                        } else {
                            // Clerk not loaded at all - fallback to login page
                            console.log('Clerk not available, redirecting to login page');
                            window.location.href = '/login.html';
                            return;
                        }
                    } catch (e) {
                        console.error('Sign in error:', e);
                        // Check if error is because user is already signed in
                        if (e.code === 'cannot_render_single_session_enabled' || 
                            (e.message && e.message.includes('already signed in'))) {
                            console.log('User is already signed in - updating UI');
                            // Force UI update
                            if (typeof Clerk !== 'undefined' && Clerk.user) {
                                loginBtn.style.display = 'none';
                                const userMenu = document.getElementById('userMenu');
                                if (userMenu) userMenu.style.display = 'flex';
                                if (typeof AuthState !== 'undefined') {
                                    AuthState.clerkUser = Clerk.user;
                                    AuthState.updateUI();
                                }
                            }
                            return;
                        }
                        // Other error - show briefly then fallback
                        loginBtn.textContent = 'Error - Retrying...';
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 1000);
                        return;
                    } finally {
                        // Reset button state (only if not navigating away)
                        isLoading = false;
                        loginBtn.textContent = originalText;
                        loginBtn.disabled = false;
                    }
                });
                console.log('‚úÖ Login button handler attached');
            }
        });
    </script>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav no-print" id="mobileNav">
        <button class="mobile-nav-item" id="mobileNavNew">
            <span class="nav-icon">‚ûï</span>
            <span class="nav-label">New Job</span>
        </button>
        <button class="mobile-nav-item" id="mobileNavSave">
            <span class="nav-icon">üíæ</span>
            <span class="nav-label">Save</span>
        </button>
        <button class="mobile-nav-item active" id="mobileNavForm">
            <span class="nav-icon">üìù</span>
            <span class="nav-label">Form</span>
        </button>
        <button class="mobile-nav-item" id="mobileNavPreview">
            <span class="nav-icon">üëÅÔ∏è</span>
            <span class="nav-label">Preview</span>
        </button>
        <button class="mobile-nav-item" id="mobileNavMore">
            <span class="nav-icon">‚ò∞</span>
            <span class="nav-label">More</span>
        </button>
    </nav>
    
    <!-- Mobile Preview Toggle FAB -->
    <button class="preview-toggle no-print" id="previewToggle" title="Preview Documents">
        üìÑ
    </button>
    
    <script>
        // Mobile Navigation Functionality
        (function() {
            const mobileNav = document.getElementById('mobileNav');
            const previewToggle = document.getElementById('previewToggle');
            const outputPanel = document.querySelector('.output-panel');
            
            // Mobile Nav: New Job
            document.getElementById('mobileNavNew')?.addEventListener('click', () => {
                document.getElementById('btnNewJob')?.click();
            });
            
            // Mobile Nav: Save
            document.getElementById('mobileNavSave')?.addEventListener('click', () => {
                document.getElementById('btnSaveDraft')?.click();
            });
            
            // Mobile Nav: Form (scroll to top)
            document.getElementById('mobileNavForm')?.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                outputPanel?.classList.remove('active');
                updateMobileNavActive('mobileNavForm');
            });
            
            // Mobile Nav: Preview
            document.getElementById('mobileNavPreview')?.addEventListener('click', () => {
                outputPanel?.classList.toggle('active');
                updateMobileNavActive('mobileNavPreview');
            });
            
            // Preview Toggle FAB
            previewToggle?.addEventListener('click', () => {
                outputPanel?.classList.toggle('active');
            });
            
            // Mobile Nav: More (open user menu or settings)
            document.getElementById('mobileNavMore')?.addEventListener('click', () => {
                const userMenu = document.getElementById('userMenuDropdown');
                if (userMenu) {
                    userMenu.classList.toggle('active');
                } else {
                    // Fallback to settings
                    document.getElementById('btnSettings')?.click();
                }
            });
            
            function updateMobileNavActive(activeId) {
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    item.classList.toggle('active', item.id === activeId);
                });
            }
            
            // Close preview on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && outputPanel?.classList.contains('active')) {
                    outputPanel.classList.remove('active');
                    updateMobileNavActive('mobileNavForm');
                }
            });
            
            // Add close button to output panel on mobile
            if (window.innerWidth <= 768 && outputPanel) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'output-close-mobile';
                closeBtn.innerHTML = '‚úï';
                closeBtn.addEventListener('click', () => {
                    outputPanel.classList.remove('active');
                    updateMobileNavActive('mobileNavForm');
                });
                outputPanel.insertBefore(closeBtn, outputPanel.firstChild);
            }
        })();
    </script>
</body>
</html>

